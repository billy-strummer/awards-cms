<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Companies in Award</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .company-link { cursor: pointer; color: #0d6efd; text-decoration: none; }
    .company-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">Companies in Award</span>
      <button class="btn btn-outline-light" onclick="goBack()">Back</button>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row mb-4">
      <div class="col-12">
        <h2 id="awardTitle">Loading...</h2>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">
        <input type="text" id="searchInput" class="form-control" placeholder="Search company name...">
      </div>
    </div>

    <table class="table table-hover table-bordered bg-white shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>Company Name</th>
          <th>Email</th>
          <th>Website</th>
          <th>Region</th>
          <th>Status</th>
          <th>View Profile</th>
        </tr>
      </thead>
      <tbody id="companiesTableBody">
        <tr><td colspan="6" class="text-center">Loading companies...</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://bipndtstiqdydtdegjdx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpcG5kdHN0aXFkeWR0ZGVnamR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDE4OTksImV4cCI6MjA3ODAxNzg5OX0.c6ImTKoKuJHRE6H9kPTVp56kjQ5i3Y2AAPgx2N_Bw6A';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allCompanies = [];
    let awardName = null;
    let awardData = null;

    async function loadCompaniesPage() {
      awardName = sessionStorage.getItem('selectedAwardName');
      
      if (!awardName) {
        document.getElementById('awardTitle').textContent = 'Award not found';
        return;
      }

      document.getElementById('awardTitle').textContent = awardName;

      // Get award details from awards table
      const { data: awards } = await client.from('awards').select('*').eq('award_name', awardName).limit(1);
      
      if (awards && awards.length > 0) {
        awardData = awards[0];
      }

      // Get all organisations with this award_name
      const { data: orgs } = await client.from('organisations').select('*').eq('award_name', awardName);
      
      if (orgs) {
        allCompanies = orgs;
        displayCompanies(allCompanies);
      }
    }

    function displayCompanies(companies) {
      const tbody = document.getElementById('companiesTableBody');
      
      if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No companies found</td></tr>';
        return;
      }

      tbody.innerHTML = companies.map(company => {
        let status = 'Nominee';
        if (awardData && awardData.winner === company.company_name) {
          status = '<span class="badge bg-success">WINNER</span>';
        }

        return `
          <tr>
            <td><a class="company-link" onclick="openCompanyProfile('${company.id}', '${company.company_name}')">${company.company_name}</a></td>
            <td><a href="mailto:${company.email}">${company.email}</a></td>
            <td><a href="${company.website}" target="_blank">${company.website || 'N/A'}</a></td>
            <td>${company.region || ''}</td>
            <td>${status}</td>
            <td>
              <a href="#" onclick="openCompanyProfile('${company.id}', '${company.company_name}')" class="btn btn-sm btn-link p-0">
                <i class="bi bi-eye"></i>
              </a>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterCompanies() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      
      const filtered = allCompanies.filter(company => {
        return (company.company_name || '').toLowerCase().includes(searchInput);
      });
      
      displayCompanies(filtered);
    }

    function openCompanyProfile(companyId, companyName) {
      sessionStorage.setItem('selectedCompanyId', companyId);
      sessionStorage.setItem('selectedCompanyName', companyName);
      window.location.href = 'company-profile.html';
    }

    function goBack() {
      window.history.back();
    }

    // Event listener for search
    document.getElementById('searchInput').addEventListener('keyup', filterCompanies);

    // Initialize
    loadCompaniesPage();
  </script>

</body>
</html>