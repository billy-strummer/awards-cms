<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>British Trade Awards Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; transition: background-color 0.3s; }
    body.dark-mode { background-color: #1a1a1a; color: #fff; }
    .login-container { max-width: 400px; margin: 100px auto; }
    .company-link { cursor: pointer; color: #0d6efd; text-decoration: none; }
    .company-link:hover { text-decoration: underline; }
    .breadcrumb { background-color: transparent; padding: 0.5rem 0; }
    .stat-card { text-align: center; padding: 20px; }
    .stat-card h6 { color: #666; font-size: 0.9rem; }
    .stat-card h3 { color: #0d6efd; margin: 10px 0 0 0; }
    .activity-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .activity-time { color: #999; font-size: 0.8rem; }
    .data-quality { display: inline-block; width: 100%; background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden; margin: 5px 0; }
    .data-quality-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); }
    .quality-badge { font-size: 0.8rem; font-weight: bold; }
    .duplicate-warning { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0; }
    .missing-data { background-color: #f8d7da; color: #721c24; }
    .preview-modal { max-width: 600px; }
    .quick-filter-btn { margin: 2px; }
    .view-card { cursor: pointer; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; margin: 5px; transition: all 0.2s; }
    .view-card:hover { border-color: #0d6efd; background-color: #f0f7ff; }
    .view-card.active { border-color: #0d6efd; background-color: #0d6efd; color: white; }
    .chart-container { position: relative; height: 300px; }
    .keyboard-hint { font-size: 0.8rem; color: #999; }
    .loading-bar { height: 3px; background: linear-gradient(90deg, #0d6efd, #20c997); animation: loading 1.5s infinite; }
    @keyframes loading { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 0%; } }
    .dark-mode .activity-item { border-bottom-color: #333; }
    .dark-mode .table { color: #fff; }
    .dark-mode .table-dark { background-color: #2a2a2a; }
    .dark-mode .card { background-color: #2a2a2a; color: #fff; }
    .dark-mode .form-control, .dark-mode .form-select { background-color: #333; color: #fff; border-color: #555; }
    @media (max-width: 768px) {
      .table { font-size: 0.9rem; }
      .btn-sm { padding: 0.25rem 0.5rem; }
      .navbar .input-group { width: 200px !important; }
    }
  </style>
</head>
<body>

  <div id="loginPage" class="container login-container">
    <div class="card shadow">
      <div class="card-body p-5">
        <h2 class="text-center mb-4">British Trade Awards Admin</h2>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="loginEmail">
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword">
        </div>
        <button class="btn btn-primary w-100" id="loginBtn">Login</button>
        <div id="loginMessage" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <div id="dashboardPage" style="display: none;">
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand fw-bold">British Trade Awards Admin</span>
        <div class="d-flex align-items-center gap-3">
          <div class="input-group input-group-sm" style="width: 250px;">
            <input type="text" class="form-control" id="globalSearch" placeholder="Search companies..." title="Keyboard: Ctrl+K">
            <button class="btn btn-outline-light" type="button" id="searchBtn" title="Search all fields"><i class="bi bi-search"></i></button>
          </div>
          <button class="btn btn-outline-light" id="darkModeToggle" title="Toggle Dark Mode"><i class="bi bi-moon"></i></button>
          <button class="btn btn-outline-light" id="logoutBtn">Logout</button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <nav aria-label="breadcrumb" class="mt-2">
        <ol class="breadcrumb" id="breadcrumb">
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </nav>

      <div id="loadingBar" class="loading-bar" style="display: none;"></div>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" id="awards-tab" data-bs-toggle="tab" href="#awards">Awards</a></li>
        <li class="nav-item"><a class="nav-link" id="organisations-tab" data-bs-toggle="tab" href="#organisations">Organisations</a></li>
        <li class="nav-item"><a class="nav-link" id="analytics-tab" data-bs-toggle="tab" href="#analytics">Analytics</a></li>
        <li class="nav-item"><a class="nav-link" id="details-tab" data-bs-toggle="tab" href="#details">Details</a></li>
        <li class="nav-item"><a class="nav-link" id="reports-tab" data-bs-toggle="tab" href="#reports">Reports</a></li>
        <li class="nav-item"><a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings">Settings</a></li>
      </ul>

      <div class="tab-content mt-3">
        
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="container-fluid">
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="card shadow-sm stat-card">
                  <h6>Total Organisations</h6>
                  <h3 id="statOrganisations">0</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card shadow-sm stat-card">
                  <h6>Total Awards</h6>
                  <h3 id="statAwards">0</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card shadow-sm stat-card">
                  <h6>Pending Awards</h6>
                  <h3 id="statPending">0</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card shadow-sm stat-card">
                  <h6>Data Quality</h6>
                  <h3 id="statQuality">0%</h3>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-8">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Recent Activity</h5>
                  </div>
                  <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="activityFeed">
                      <p class="text-muted text-center">No recent activity</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Quick Actions</h5>
                  </div>
                  <div class="card-body">
                    <button class="btn btn-primary w-100 mb-2" data-bs-toggle="tab" href="#organisations"><i class="bi bi-plus"></i> Add Company</button>
                    <button class="btn btn-outline-primary w-100 mb-2" id="exportBtn"><i class="bi bi-download"></i> Export Data</button>
                    <button class="btn btn-outline-warning w-100 mb-2" id="duplicateCheckBtn"><i class="bi bi-exclamation-triangle"></i> Check Duplicates</button>
                    <button class="btn btn-outline-secondary w-100" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Saved Views</h5>
                  </div>
                  <div class="card-body">
                    <div id="savedViews"></div>
                    <button class="btn btn-sm btn-success w-100 mt-2" id="saveViewBtn"><i class="bi bi-bookmark"></i> Save Current View</button>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Quick Filters</h5>
                  </div>
                  <div class="card-body">
                    <button class="btn btn-sm btn-outline-info quick-filter-btn" onclick="quickFilter('missing-data')"><i class="bi bi-exclamation-circle"></i> Missing Data</button>
                    <button class="btn btn-sm btn-outline-info quick-filter-btn" onclick="quickFilter('recent')"><i class="bi bi-clock"></i> Recent</button>
                    <button class="btn btn-sm btn-outline-info quick-filter-btn" onclick="quickFilter('incomplete')"><i class="bi bi-percent"></i> Incomplete</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="container-fluid mt-4">
              <h5>Top Companies</h5>
              <table class="table table-hover table-bordered bg-white shadow-sm">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Company Name</th>
                    <th>Email</th>
                    <th>Website</th>
                    <th>Quality</th>
                  </tr>
                </thead>
                <tbody id="topCompaniesTableBody">
                  <tr><td colspan="5" class="text-center">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Awards Tab -->
        <div class="tab-pane fade" id="awards" role="tabpanel">
          <div class="container-fluid">
            <div class="row mb-3 g-2">
              <div class="col-md-3">
                <label class="form-label">Year:</label>
                <select id="yearSelect" class="form-select">
                  <option value="">All Years</option>
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Sector:</label>
                <select id="sectorFilter" class="form-select">
                  <option value="">All Sectors</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Region:</label>
                <select id="regionFilter" class="form-select">
                  <option value="">All Regions</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Search:</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Award name...">
              </div>
            </div>

            <table class="table table-hover table-bordered bg-white shadow-sm">
              <thead class="table-dark">
                <tr>
                  <th>Sector</th>
                  <th>Region</th>
                  <th>Award</th>
                  <th>Winner</th>
                  <th>Nominees</th>
                  <th>Votes</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="awardsTableBody">
                <tr><td colspan="7" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Organisations Tab -->
        <div class="tab-pane fade" id="organisations" role="tabpanel">
          <h5>All Organisations</h5>
          <div class="row mb-3 g-2">
            <div class="col-md-2">
              <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#bulkImportModal"><i class="bi bi-upload"></i> Import CSV</button>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-primary w-100" id="exportOrgBtn"><i class="bi bi-download"></i> Export</button>
            </div>
            <div class="col-md-2">
              <select id="regionFilterOrg" class="form-select">
                <option value="">All Regions</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="awardFilterOrg" class="form-select">
                <option value="">All Awards</option>
              </select>
            </div>
            <div class="col-md-4">
              <input type="text" id="orgSearchInput" class="form-control" placeholder="Search...">
            </div>
          </div>
          <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-dark">
              <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>Region</th>
                <th>Award Name</th>
                <th>Company Name</th>
                <th>Email</th>
                <th>Website</th>
                <th>Address</th>
                <th>Quality</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="organisationsTableBody">
              <tr><td colspan="9" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
          <div class="container-fluid">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Awards by Region</h5>
                  </div>
                  <div class="card-body">
                    <div id="chartAwardsByRegion"></div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Companies by Sector</h5>
                  </div>
                  <div class="card-body">
                    <div id="chartCompaniesBySector"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-12">
                <div class="card shadow-sm">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Data Quality Summary</h5>
                  </div>
                  <div class="card-body">
                    <div id="dataQualitySummary"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Details Tab -->
        <div class="tab-pane fade" id="details" role="tabpanel">
          <div class="container mt-3">
            <h5>Detail Information</h5>
            <p>Details content here</p>
          </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel">
          <div class="container mt-3">
            <h5>Reports Overview</h5>
            <p>Total Awards: <strong id="reportsTotal">0</strong></p>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
          <div class="container mt-3">
            <h5>Admin Settings</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">Display Settings</div>
                  <div class="card-body">
                    <label class="form-check-label">
                      <input type="checkbox" class="form-check-input" id="darkModeCheckbox"> Dark Mode
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog preview-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewTitle">Company Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="previewBody">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="editFromPreview">Edit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div class="modal fade" id="bulkImportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import Companies from CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="file" id="csvFile" class="form-control" accept=".csv">
          <small class="text-muted d-block mt-2">CSV should have columns: region, award_name, company_name, email, website, address, notes</small>
          <div id="importPreview" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmImport">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Duplicates Modal -->
  <div class="modal fade" id="duplicatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Duplicate Detection</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="duplicatesContent">
          <p class="text-muted">Scanning for duplicates...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://bipndtstiqdydtdegjdx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpcG5kdHN0aXFkeWR0ZGVnamR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDE4OTksImV4cCI6MjA3ODAxNzg5OX0.c6ImTKoKuJHRE6H9kPTVp56kjQ5i3Y2AAPgx2N_Bw6A';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let allAwards = [];
    let allOrganisations = [];
    let activityLog = [];
    let savedViews = JSON.parse(localStorage.getItem('savedViews')) || [];
    let importedData = [];

    function showLogin() {
      document.getElementById('loginPage').style.display = 'block';
      document.getElementById('dashboardPage').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboardPage').style.display = 'block';
    }

    // Keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('globalSearch').focus();
      }
    });

    // Dark Mode
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('darkModeCheckbox').checked = true;
    }

    document.getElementById('darkModeCheckbox').addEventListener('change', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });

    // Global Search
    document.getElementById('globalSearch').addEventListener('keyup', (e) => {
      const query = e.target.value.toLowerCase();
      if (query.length > 0) {
        const results = allOrganisations.filter(org =>
          org.company_name.toLowerCase().includes(query) ||
          org.email.toLowerCase().includes(query) ||
          org.award_name.toLowerCase().includes(query) ||
          org.region.toLowerCase().includes(query)
        );
        displayOrganisations(results);
      } else {
        displayOrganisations(allOrganisations);
      }
    });

    async function loadAwards() {
      showLoadingBar();
      let allData = [];
      let offset = 0;
      let hasMore = true;
      while (hasMore) {
        const { data } = await client.from('awards').select('*').range(offset, offset + 999);
        if (!data || data.length === 0) hasMore = false;
        else {
          allData = allData.concat(data);
          offset += 1000;
        }
      }
      allAwards = allData;
      setTimeout(function() {
        populateFilters();
        displayAwards(allAwards);
        updateDashboard();
        hideLoadingBar();
      }, 100);
    }

    async function loadOrganisations() {
      showLoadingBar();
      let allData = [];
      let offset = 0;
      let hasMore = true;
      
      while (hasMore) {
        const { data } = await client.from('organisations').select('*').range(offset, offset + 999);
        if (!data || data.length === 0) hasMore = false;
        else {
          allData = allData.concat(data);
          offset += 1000;
        }
      }
      
      allOrganisations = allData;
      populateOrgFilters();
      displayOrganisations(allOrganisations);
      addActivityLog('Loaded organisations');
      hideLoadingBar();
    }

    function calculateDataQuality(org) {
      let score = 0;
      if (org.company_name) score += 20;
      if (org.email && org.email.includes('@')) score += 20;
      if (org.website && org.website.includes('.')) score += 20;
      if (org.address) score += 20;
      if (org.award_name) score += 20;
      return score;
    }

    function displayOrganisations(organisations) {
      const tbody = document.getElementById('organisationsTableBody');
      if (organisations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No organisations found</td></tr>';
        return;
      }
      tbody.innerHTML = organisations.map(org => {
        const quality = calculateDataQuality(org);
        const qualityColor = quality >= 80 ? 'success' : quality >= 60 ? 'warning' : 'danger';
        const missingFields = [];
        if (!org.company_name) missingFields.push('name');
        if (!org.email) missingFields.push('email');
        if (!org.website) missingFields.push('website');
        
        return `<tr ${missingFields.length > 0 ? 'class="missing-data"' : ''}>
          <td><input type="checkbox" class="org-checkbox" value="${org.id}"></td>
          <td>${org.region || ''}</td>
          <td><a href="javascript:void(0);" onclick="viewAwardNominees('${(org.award_name || '').replace(/'/g, "\\'")}')" class="text-decoration-none">${org.award_name || ''}</a></td>
          <td><a href="javascript:void(0);" class="company-link" onclick="previewCompany('${org.id}', '${(org.company_name || '').replace(/'/g, "\\'")}')">${org.company_name || ''}</a></td>
          <td><a href="mailto:${org.email}">${org.email || ''}</a></td>
          <td><a href="${org.website}" target="_blank">${org.website || ''}</a></td>
          <td>${org.address || ''}</td>
          <td><span class="badge bg-${qualityColor}">${quality}%</span></td>
          <td><button class="btn btn-sm btn-info" onclick="previewCompany('${org.id}', '${(org.company_name || '').replace(/'/g, "\\'")}')" title="Preview"><i class="bi bi-eye"></i></button> <button class="btn btn-sm btn-danger" onclick="deleteOrganisation('${org.id}')" title="Delete"><i class="bi bi-trash"></i></button></td>
        </tr>`;
      }).join('');
      
      document.querySelectorAll('.org-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkDeleteButton);
      });
    }

    function previewCompany(id, name) {
      const org = allOrganisations.find(o => o.id === id);
      if (!org) return;

      const quality = calculateDataQuality(org);
      const html = `
        <h6>${org.company_name}</h6>
        <hr>
        <p><strong>Email:</strong> <a href="mailto:${org.email}">${org.email}</a></p>
        <p><strong>Website:</strong> <a href="${org.website}" target="_blank">${org.website}</a></p>
        <p><strong>Address:</strong> ${org.address}</p>
        <p><strong>Region:</strong> ${org.region}</p>
        <p><strong>Award:</strong> ${org.award_name}</p>
        <p><strong>Notes:</strong> ${org.notes}</p>
        <hr>
        <p><strong>Data Quality:</strong> <span class="badge bg-${quality >= 80 ? 'success' : quality >= 60 ? 'warning' : 'danger'}">${quality}%</span></p>
      `;
      
      document.