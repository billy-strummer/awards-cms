<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>British Trade Awards Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .login-container { max-width: 400px; margin: 100px auto; }
    .company-link { cursor: pointer; color: #0d6efd; text-decoration: none; }
    .company-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="container login-container">
    <div class="card shadow">
      <div class="card-body p-5">
        <h2 class="text-center mb-4">British Trade Awards Admin</h2>

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="loginEmail">
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword">
        </div>

        <button class="btn btn-primary w-100" id="loginBtn">Login</button>

        <div id="loginMessage" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DASHBOARD -->
  <div id="dashboardPage" style="display: none;">

    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand fw-bold">British Trade Awards Admin</span>
        <button class="btn btn-outline-light" id="logoutBtn">Logout</button>
      </div>
    </nav>

    <div class="container-fluid">

      <!-- TABS -->
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" id="awards-tab" data-bs-toggle="tab" href="#awards">Awards</a></li>
        <li class="nav-item"><a class="nav-link" id="organisations-tab" data-bs-toggle="tab" href="#organisations">Organisations</a></li>
        <li class="nav-item"><a class="nav-link" id="details-tab" data-bs-toggle="tab" href="#details">Details</a></li>
        <li class="nav-item"><a class="nav-link" id="reports-tab" data-bs-toggle="tab" href="#reports">Reports</a></li>
        <li class="nav-item"><a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings">Settings</a></li>
      </ul>

      <div class="tab-content mt-3">

        <!-- OVERVIEW TAB -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="container mt-3">
            <div class="row g-3">

              <div class="col-md-4">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">Awards Summary</h5>
                    <p>Total Awards: <strong id="totalAwards">0</strong><br>Pending: <strong id="pendingAwards">0</strong></p>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">Calendar</h5>
                    <p>Next Event: <strong>Industry Gala</strong><br>Date: <strong>12 Dec 2025</strong></p>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title">Events</h5>
                    <p>Upcoming: <strong>5</strong><br>Completed: <strong>7</strong></p>
                  </div>
                </div>
              </div>

            </div>

            <div class="container mt-4">
              <h5>Top Companies</h5>
              <table class="table table-hover table-bordered bg-white shadow-sm">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Company Name</th>
                    <th>Email</th>
                    <th>Website</th>
                    <th>Address</th>
                    <th>Region</th>
                  </tr>
                </thead>
                <tbody id="topCompaniesTableBody">
                  <tr><td colspan="6" class="text-center">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- AWARDS TAB -->
        <div class="tab-pane fade" id="awards" role="tabpanel">
          <div class="container-fluid">

            <div class="row mb-3 g-2">
              <div class="col-md-3">
                <label class="form-label">Year:</label>
                <select id="yearSelect" class="form-select">
                  <option value="">All Years</option>
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Sector:</label>
                <select id="sectorFilter" class="form-select">
                  <option value="">All Sectors</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Region:</label>
                <select id="regionFilter" class="form-select">
                  <option value="">All Regions</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Search:</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Award name...">
              </div>
            </div>

            <table class="table table-hover table-bordered bg-white shadow-sm">
              <thead class="table-dark">
                <tr>
                  <th>Sector</th>
                  <th>Region</th>
                  <th>Award</th>
                  <th>Winner</th>
                  <th>Nominees</th>
                  <th>Votes</th>
                  <th>Status</th>
                </tr>
              </thead>

              <tbody id="awardsTableBody">
                <tr><td colspan="7" class="text-center">Loading...</td></tr>
              </tbody>
            </table>

          </div>
        </div>

        <!-- ORGANISATIONS TAB -->
        <div class="tab-pane fade" id="organisations" role="tabpanel">

          <h5>All Organisations</h5>

          <div class="row mb-3 g-2">
            <div class="col-md-4">
              <input type="text" id="orgSearchInput" class="form-control" placeholder="Company name...">
            </div>
          </div>

          <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>Region <button class="btn btn-sm btn-light" onclick="sortOrgsColumn('region')">↕</button></th>
                <th>Award Name <button class="btn btn-sm btn-light" onclick="sortOrgsColumn('award_name')">↕</button></th>
                <th>Company Name <button class="btn btn-sm btn-light" onclick="sortOrgsColumn('company_name')">↕</button></th>
                <th>Email</th>
                <th>Website</th>
                <th>Address</th>
                <th>Notes</th>
              </tr>
            </thead>

            <tbody id="organisationsTableBody">
              <tr><td colspan="7" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- DETAILS TAB -->
        <div class="tab-pane fade" id="details" role="tabpanel">
          <div class="container mt-3">
            <h5>Detail Information</h5>
            <p>Details content here</p>
          </div>
        </div>

        <!-- REPORTS TAB -->
        <div class="tab-pane fade" id="reports" role="tabpanel">
          <div class="container mt-3">
            <h5>Reports Overview</h5>
            <p>Total Awards: <strong id="reportsTotal">0</strong></p>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
          <div class="container mt-3">
            <h5>Admin Settings</h5>
            <p>Settings content here...</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- SUPABASE JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /****************************************************
     *  SUPABASE INIT — FIXED!
     ****************************************************/
    const SUPABASE_URL = "https://bipndtstiqdydtdegjdx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpcG5kdHN0aXFkeWR0ZGVnamR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDE4OTksImV4cCI6MjA3ODAxNzg5OX0.c6ImTKoKuJHRE6H9kPTVp56kjQ5i3Y2AAPgx2N_Bw6A"; // You can re-paste your anon key

    const client = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allAwards = [];
    let allOrganisations = [];

    /****************************************************
     * LOGIN + LOGOUT
     ****************************************************/
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const { error } = await client.auth.signInWithPassword({ email, password });

      if (error) {
        document.getElementById("loginMessage").innerHTML =
          `<div class="alert alert-danger">${error.message}</div>`;
      } else {
        showDashboard();
        loadAwards();
        loadOrganisations();
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await client.auth.signOut();
      showLogin();
    });

    function showLogin() {
      document.getElementById("loginPage").style.display = "block";
      document.getElementById("dashboardPage").style.display = "none";
    }

    function showDashboard() {
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("dashboardPage").style.display = "block";
    }

    /****************************************************
     * CHECK SESSION
     ****************************************************/
    async function checkAuth() {
      const { data: { session } } = await client.auth.getSession();
      if (session) {
        showDashboard();
        loadAwards();
        loadOrganisations();
      } else {
        showLogin();
      }
    }
    checkAuth();

    /****************************************************
     * LOAD AWARDS
     ****************************************************/
    async function loadAwards() {
      let allData = [];
      let offset = 0;
      let hasMore = true;

      while (hasMore) {
        const { data } = await client.from("awards").select("*").range(offset, offset + 999);
        if (!data || data.length === 0) hasMore = false;
        else {
          allData.push(...data);
          offset += 1000;
        }
      }

      allAwards = allData;

      populateFilters();
      displayAwards(allAwards);
      updateDashboard();
    }

    /****************************************************
     * LOAD ORGANISATIONS
     ****************************************************/
    async function loadOrganisations() {
      let allData = [];
      let offset = 0;
      let hasMore = true;

      while (hasMore) {
        const { data } = await client.from("organisations").select("*").range(offset, offset + 999);
        if (!data || data.length === 0) hasMore = false;
        else {
          allData.push(...data);
          offset += 1000;
        }
      }

      allOrganisations = allData;
      displayOrganisations(allOrganisations);
      updateDashboard();
    }

    /****************************************************
     * DISPLAY ORGANISATIONS
     ****************************************************/
    function displayOrganisations(list) {
      const tbody = document.getElementById("organisationsTableBody");

      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">No organisations found</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(org => `
        <tr>
          <td>${org.region || ""}</td>
          <td>${org.award_name || ""}</td>
          <td>${org.company_name || ""}</td>
          <td>${org.email || ""}</td>
          <td>${org.website || ""}</td>
          <td>${org.address || ""}</td>
          <td>${org.notes || ""}</td>
        </tr>
      `).join("");
    }

    /****************************************************
     * DISPLAY AWARDS
     ****************************************************/
    function displayAwards(list) {
      const tbody = document.getElementById("awardsTableBody");

      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7">No awards found</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(a => `
        <tr>
          <td>${a.sector}</td>
          <td>${a.region}</td>
          <td>${a.award_name}</td>
          <td>${a.winner}</td>
          <td>${a.nominees_count}</td>
          <td>${a.votes_count}</td>
          <td>${a.status}</td>
        </tr>
      `).join("");
    }

    /****************************************************
     * POPULATE FILTERS
     ****************************************************/
    function populateFilters() {
      const sectorSelect = document.getElementById("sectorFilter");
      const regionSelect = document.getElementById("regionFilter");

      const sectors = [...new Set(allAwards.map(a => a.sector).filter(Boolean))].sort();
      const regions = [...new Set(allAwards.map(a => a.region).filter(Boolean))].sort();

      sectorSelect.innerHTML = `<option value="">All Sectors</option>`;
      sectors.forEach(s => sectorSelect.innerHTML += `<option value="${s}">${s}</option>`);

      regionSelect.innerHTML = `<option value="">All Regions</option>`;
      regions.forEach(r => regionSelect.innerHTML += `<option value="${r}">${r}</option>`);
    }

  </script>
</body>
</html>
